---
title: "Ficha de Información Metropolitana"
author: "Alvaro"
date: "2023-02-27"
output: html_document
runtime: shiny
---
<div style="text-align: justify">  <div/>

La ficha de información metropolitana es un recurso valioso para la planificación territorial en zonas metropolitanas. En ella se incluyen datos censales en diversos formatos, como gráficas, tablas y mapas provenientes principalmente de los censos económicos de los años 1999, 2004, 2009, 2014 y 2019. A su vez, también incluye información de los censos de población y vivienda del año 2020, ambos censos son publicados por el Instituto Nacional de Estadística y Geografía (INEGI).

El propósito principal de esta ficha es proporcionar datos esenciales para la planificación territorial a nivel de zona metropolitana. Es decir, esta ficha incluye ciertos conjuntos de datos que recopilen inicialmente el proceso de planificación, los cuales describen las características socioeconómicas y espaciales de la zona. Por tanto, estos datos son particularmente útiles en una etapa de diagnóstico y formulación de objetivos, así como el planteamiento de una hipótesis en la planificación.

La base socio-demográfica se obtuvo de los Censos de Población y Vivienda, 2020, en el apartado de Tabulados/Características de las localidades. La base original de INEGI se filtro solo para la información a nivel municipal y se eliminaron algunas variables sin relevancia.

Se utiliza la función 'renderUI' del paquete Shiny para crear un menú interactivo en un informe esta función se utiliza junto con la función 'uiOutput' para mostrar la salida en el informe.

Con renderUI se crea una lista desplegable en la que el usuario pueda seleccionar una variable. Luego, con la ayuda de un controlador en el servidor (observeEvent), se puede responder a la selección del usuario y actualizar la información mostrada en el informe.

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Importación de la base
library(readxl)
library(shiny)
library(dplyr)
library(tidyverse)
library(openxlsx)
library(shinyWidgets)

Base_sociodemo <- read_excel("C:\\Users\\leope\\Documents\\RepTemplates\\ZonasMetro\\Bases de datos\\Base _sociodemo.xlsx")
zm19 <- read_excel("C:\\Users\\leope\\Documents\\RepTemplates\\ZonasMetro\\Bases de datos\\zm19.xlsx")

#Se crea la variable cve_geo
Base_sociodemo$cvegeo <- paste(Base_sociodemo$CVE_ENT, Base_sociodemo$MUN, sep = "")

#Colocación de las claves de zona metropolitana
Variables <- select(zm19, cvegeo,  CVE_ZM,  NOM_ZM)
Base_sociodemo <- merge(Base_sociodemo, Variables, by = "cvegeo", all = TRUE)


##Comienza la aplicación

ui <- fluidPage(
  selectInput("zmvm",
              "Selecciona una ZM:", unique(Base_sociodemo$NOM_ZM), selected = NULL),
  selectInput("variables", "Selecciona variables sociodemograficas a mostrar:",
    choices = names(Base_sociodemo), multiple = TRUE, selected = NULL),
  selectInput("variables2", "Selecciona variables economicas a mostrar:",
    choices = names(zm19), multiple = TRUE, selected = NULL),
  tableOutput("informacion"),
  downloadButton("descargar", "Descargar tabla")
)
#Vincula la entrada de usuario con el servidor
server <- function(input, output) {
  
  output$informacion <- renderTable({
    datos <- merge(subset(Base_sociodemo, NOM_ZM == input$zmvm),
    subset(zm19, NOM_ZM == input$zmvm), 
    by = "cvegeo",
    all = TRUE)
    tabla <- datos[,c(input$variables, input$variables2), drop = FALSE]
  })
  
#Función para descarfar la tabla de datos en CSV
  output$descargar <- downloadHandler(
    filename = function() {
      paste("Tabla-", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      datos <- merge(subset(Base_sociodemo, NOM_ZM == input$zmvm),
                     subset(zm19, NOM_ZM == input$zmvm), 
                     by = "cvegeo",
                     all = TRUE)
      tabla <- datos[,c(input$variables, input$variables2), drop = FALSE]
      write.csv(tabla, file, row.names = FALSE, fileEncoding = "UTF-8")
    }
  )       
}

shinyApp(ui, server)
```
